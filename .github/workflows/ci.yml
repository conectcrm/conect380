name: CI - Testes e Build

on:
  push:
    branches: [main, develop, consolidacao-*]
  pull_request:
    branches: [main, develop]

jobs:
  encoding-guardrails:
    name: Guardrails - Encoding
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'

      - name: Detectar arquivos alterados
        run: |
          set -e

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "PR: verificando diff contra base branch (${{ github.base_ref }})"
            git fetch --no-tags --prune --depth=1 origin "${{ github.base_ref }}"
            git diff --name-only --diff-filter=ACMR "origin/${{ github.base_ref }}...HEAD" > changed_files.txt || true
          else
            echo "Push: verificando diff do último commit"
            git diff --name-only --diff-filter=ACMR HEAD^ HEAD > changed_files.txt || true
          fi

          echo "Arquivos alterados (primeiros 50):"
          head -n 50 changed_files.txt || true

      - name: Rodar check de encoding (arquivos alterados)
        run: |
          if [ ! -s changed_files.txt ]; then
            echo "Nenhum arquivo alterado para verificar."
            exit 0
          fi

          cat changed_files.txt | node scripts/checkEncoding.js --stdin

  backend:
    name: Backend - Testes e Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: npm
          cache-dependency-path: backend/package-lock.json

      - name: Instalar dependencias backend
        run: npm --prefix backend ci

      - name: Type-check backend
        run: npm --prefix backend run type-check

      - name: Build backend
        run: npm --prefix backend run build

  frontend:
    name: Frontend - Testes e Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.16.0'
          cache: npm
          cache-dependency-path: frontend-web/package-lock.json

      - name: Instalar dependencias frontend
        run: npm --prefix frontend-web ci

      - name: Sanity check frontend
        run: npm --prefix frontend-web run deps:check || true

  security:
    name: Analise de Seguranca
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4

      - name: Inicializar CodeQL
        uses: github/codeql-action/init@v2
        with:
          languages: javascript, typescript

      - name: Executar analise CodeQL
        uses: github/codeql-action/analyze@v2

  check-temp-files:
    name: Verificar Arquivos Temporarios
    runs-on: ubuntu-latest

    steps:
      - name: Checkout codigo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Verificar arquivos temporarios
        run: |
          echo "Verificando arquivos temporarios alterados no commit..."
          CHANGED_FILES=$(git diff --name-only --diff-filter=ACMR HEAD^ HEAD || true)

          if [ -z "$CHANGED_FILES" ]; then
            echo "Nenhum arquivo alterado detectado no commit atual."
            exit 0
          fi

          TEMP_FILES=$(echo "$CHANGED_FILES" | grep -E '(^|/)(test-|debug-|temp-|exemplo-|CORRECAO_|DEBUG_)' || true)

          if [ -n "$TEMP_FILES" ]; then
            echo "Arquivos temporarios encontrados:"
            echo "$TEMP_FILES"
            exit 1
          else
            echo "Nenhum arquivo temporario encontrado."
          fi

  final-status:
    name: Status Final do CI
    runs-on: ubuntu-latest
    needs: [encoding-guardrails, backend, frontend, security, check-temp-files]
    if: always()

    steps:
      - name: Verificar status dos jobs
        run: |
          echo "Encoding Guardrails: ${{ needs.encoding-guardrails.result }}"
          echo "Backend: ${{ needs.backend.result }}"
          echo "Frontend: ${{ needs.frontend.result }}"
          echo "Security: ${{ needs.security.result }}"
          echo "Temp Files Check: ${{ needs.check-temp-files.result }}"

          if [ "${{ needs.encoding-guardrails.result }}" != "success" ] || \
             [ "${{ needs.backend.result }}" != "success" ] || \
             [ "${{ needs.frontend.result }}" != "success" ] || \
             [ "${{ needs.security.result }}" != "success" ] || \
             [ "${{ needs.check-temp-files.result }}" != "success" ]; then
            echo "CI falhou em um ou mais jobs"
            exit 1
          else
            echo "Todos os jobs passaram com sucesso"
          fi
