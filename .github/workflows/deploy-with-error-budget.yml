name: Deploy with Error Budget Check

on:
  push:
    branches:
      - production
  workflow_dispatch:
    inputs:
      override_freeze:
        description: 'Override deploy freeze (requires CTO approval)'
        required: false
        type: boolean
        default: false

env:
  # Importante: sem fallback. Se nÃ£o existir secret, o workflow deve reportar misconfiguration e nÃ£o falhar.
  PROMETHEUS_URL: ${{ secrets.PROMETHEUS_URL }}

jobs:
  check-error-budget:
    name: Check Error Budget
    runs-on: ubuntu-latest
    outputs:
      can_deploy: ${{ steps.check.outputs.can_deploy }}
      budget_status: ${{ steps.check.outputs.status }}
      budget_remaining: ${{ steps.check.outputs.remaining }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc
      
      - name: Check error budget
        id: check
        env:
          OVERRIDE_DEPLOY: ${{ github.event.inputs.override_freeze }}
          OVERRIDE_DEPLOY_FREEZE: ${{ github.event.inputs.override_freeze }}
        run: |
          # Se PROMETHEUS_URL nÃ£o estiver configurado, nÃ£o falhar o workflow.
          # Apenas bloqueia o deploy e registra o motivo.
          if [ -z "${PROMETHEUS_URL:-}" ]; then
            echo "can_deploy=false" >> $GITHUB_OUTPUT
            echo "status=MISCONFIGURED" >> $GITHUB_OUTPUT
            echo "remaining=" >> $GITHUB_OUTPUT
            echo "âŒ PROMETHEUS_URL nÃ£o configurado (GitHub Secret ausente)." >> $GITHUB_STEP_SUMMARY
            echo "â¡ï¸ Configure o secret PROMETHEUS_URL ou use um runner self-hosted na mesma rede do Prometheus." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          chmod +x scripts/can-deploy.sh
          chmod +x scripts/check-error-budget.sh
          
          # Executar verificaÃ§Ã£o
          if ./scripts/can-deploy.sh; then
            echo "can_deploy=true" >> $GITHUB_OUTPUT
            echo "status=NORMAL" >> $GITHUB_OUTPUT
            echo "âœ… Deploy permitido" >> $GITHUB_STEP_SUMMARY
          else
            EXIT_CODE=$?
            echo "can_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ Deploy bloqueado (exit code: $EXIT_CODE)" >> $GITHUB_STEP_SUMMARY
            
            # Ler status do JSON
            if [ -f /tmp/error-budget-status.json ]; then
              STATUS=$(jq -r '.error_budget.status' /tmp/error-budget-status.json)
              REMAINING=$(jq -r '.error_budget.remaining_percent' /tmp/error-budget-status.json)
              echo "status=$STATUS" >> $GITHUB_OUTPUT
              echo "remaining=$REMAINING" >> $GITHUB_OUTPUT
              
              echo "### Error Budget Status: $STATUS" >> $GITHUB_STEP_SUMMARY
              echo "Budget Remaining: $REMAINING%" >> $GITHUB_STEP_SUMMARY
            else
              echo "status=UNKNOWN" >> $GITHUB_OUTPUT
              echo "remaining=" >> $GITHUB_OUTPUT
            fi

            # NÃ£o falhar o job â€” apenas bloquear as etapas seguintes.
            exit 0
          fi
      
      - name: Upload error budget status
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: error-budget-status
          path: /tmp/error-budget-status.json
  
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: check-error-budget
    if: needs.check-error-budget.outputs.can_deploy == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22.16.0'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json
      
      - name: Install dependencies
        working-directory: backend
        run: npm ci
      
      - name: Run tests
        working-directory: backend
        run: npm test
      
      - name: Build
        working-directory: backend
        run: npm run build
      
      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-build
          path: backend/dist
  
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [check-error-budget, build]
    if: needs.check-error-budget.outputs.can_deploy == 'true'
    environment:
      name: production
      url: https://conectcrm.com
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Download build artifact
        uses: actions/download-artifact@v3
        with:
          name: backend-build
          path: backend/dist
      
      - name: Deploy to production
        run: |
          echo "ğŸš€ Deploying to production..."
          # Adicionar comandos de deploy aqui
          # Ex: scp, rsync, kubectl, docker push, etc.
      
      - name: Notify success
        if: success()
        run: |
          echo "âœ… Deploy completed successfully"
          echo "Error Budget Status: ${{ needs.check-error-budget.outputs.budget_status }}"
          echo "Budget Remaining: ${{ needs.check-error-budget.outputs.budget_remaining }}%"
      
      - name: Log deploy freeze override
        if: github.event.inputs.override_freeze == 'true'
        run: |
          echo "âš ï¸  DEPLOY FREEZE WAS OVERRIDDEN"
          echo "Approver: ${{ github.actor }}"
          echo "Timestamp: $(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          echo "Commit: ${{ github.sha }}"
          # Enviar para sistema de auditoria
  
  notify-blocked:
    name: Notify Deploy Blocked
    runs-on: ubuntu-latest
    needs: check-error-budget
    if: needs.check-error-budget.outputs.can_deploy != 'true'
    
    steps:
      - name: Notify team
        run: |
          echo "ğŸš« Deploy bloqueado devido ao error budget"
          echo "Status: ${{ needs.check-error-budget.outputs.budget_status }}"
          echo "Budget Remaining: ${{ needs.check-error-budget.outputs.budget_remaining }}%"
          
          # Enviar notificaÃ§Ã£o para Slack
          # curl -X POST ${{ secrets.SLACK_WEBHOOK_URL }} \
          #   -H 'Content-Type: application/json' \
          #   -d '{
          #     "text": "ğŸš« Deploy bloqueado",
          #     "blocks": [
          #       {
          #         "type": "section",
          #         "text": {
          #           "type": "mrkdwn",
          #           "text": "*Deploy Bloqueado*\nError Budget: ${{ needs.check-error-budget.outputs.budget_remaining }}%\nStatus: ${{ needs.check-error-budget.outputs.budget_status }}"
          #         }
          #       }
          #     ]
          #   }'
      
      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸš« Deploy Bloqueado
              
              **Motivo**: Error budget muito baixo
              
              **Status**: ${{ needs.check-error-budget.outputs.budget_status }}
              **Budget Remaining**: ${{ needs.check-error-budget.outputs.budget_remaining }}%
              
              ### AÃ§Ãµes necessÃ¡rias:
              
              ${
                needs.check-error-budget.outputs.budget_status === 'FREEZE'
                  ? '- âŒ Deploy FREEZE ativo\n- âš ï¸ Apenas correÃ§Ãµes crÃ­ticas de seguranÃ§a/disponibilidade\n- ğŸ“ AprovaÃ§Ã£o do CTO obrigatÃ³ria'
                  : needs.check-error-budget.outputs.budget_status === 'WARNING'
                  ? '- âš ï¸ Modo de confiabilidade ativo\n- ğŸ”§ Apenas correÃ§Ãµes de emergÃªncia\n- ğŸ“‹ Revisar todas as mudanÃ§as cuidadosamente'
                  : '- ğŸ” Investigar causa do consumo de error budget\n- ğŸ“Š Analisar mÃ©tricas de SLO\n- ğŸ› ï¸ Implementar melhorias de confiabilidade'
              }
              
              [Ver Dashboard de Error Budget](https://grafana.conectcrm.com/d/error-budget-slo)
              `
            })
