import React, { createContext, useContext, ReactNode, useState, useEffect, useCallback } from 'react';
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';
import LanguageDetector from 'i18next-browser-languagedetector';

// ConfiguraÃ§Ã£o do i18next
i18n
  .use(LanguageDetector)
  .use(initReactI18next)
  .init({
    fallbackLng: 'pt-BR',
    debug: false, // Debug desabilitado para produÃ§Ã£o
    interpolation: {
      escapeValue: false,
    },
    detection: {
      // ConfiguraÃ§Ã£o para usar localStorage
      order: ['localStorage', 'navigator'],
      caches: ['localStorage'],
      lookupLocalStorage: 'preferred-language'
    },
    resources: {
      'pt-BR': {
        translation: {
          // Textos da aplicaÃ§Ã£o em portuguÃªs
          common: {
            save: 'Salvar',
            cancel: 'Cancelar',
            delete: 'Excluir',
            edit: 'Editar',
            add: 'Adicionar',
            search: 'Pesquisar',
            loading: 'Carregando...',
            error: 'Erro',
            success: 'Sucesso',
            actions: 'AÃ§Ãµes',
            filters: 'Filtros',
            export: 'Exportar',
            import: 'Importar',
            refresh: 'Atualizar',
            close: 'Fechar',
            confirm: 'Confirmar',
            all: 'Todos',
            none: 'Nenhum',
            view: 'Visualizar',
            viewAll: 'Ver todos',
            preferences: 'PreferÃªncias',
            systemLanguage: 'Idioma do sistema',
            helpSupport: 'Ajuda e Suporte',
            helpCenter: 'Central de ajuda',
            endSession: 'Encerrar sessÃ£o',
            required: 'obrigatÃ³rio',
            optional: 'opcional',
            update: 'Atualizar',
            register: 'Cadastrar',
            contact: 'Contato',
            position: 'Cargo',
            yes: 'Sim',
            no: 'NÃ£o',
            complement: 'Complemento',
            neighborhood: 'Bairro',
            subtotal: 'Subtotal',
            discount: 'Desconto',
            taxes: 'Impostos',
            cashPayment: 'Ã€ Vista',
            generateProposal: 'Gerar Proposta',
            automaticRenewal: 'RenovaÃ§Ã£o AutomÃ¡tica',
            frequency: 'FrequÃªncia',
            saveProduct: 'Salvar Produto',
            contactPerson: 'Pessoa de Contato',
            client: 'Cliente',
          },
          form: {
            requiredFields: 'Campos obrigatÃ³rios marcados com *',
            validForm: 'FormulÃ¡rio vÃ¡lido',
            fieldsWithError: 'campo(s) com erro',
            fillRequired: 'Preencha todos os campos obrigatÃ³rios',
            fillAllRequired: 'Preencha todos os campos obrigatÃ³rios',
            fillAllRequiredFields: 'Preencha todos os campos obrigatÃ³rios',
          },
          auth: {
            login: 'Entrar',
            logout: 'Sair',
            email: 'E-mail',
            password: 'Senha',
            forgotPassword: 'Esqueci minha senha',
            rememberMe: 'Lembrar de mim',
          },
          navigation: {
            dashboard: 'Dashboard',
            clients: 'Clientes',
            proposals: 'Propostas',
            products: 'Produtos',
            contracts: 'Contratos',
            financial: 'Financeiro',
            settings: 'ConfiguraÃ§Ãµes',
            main: 'Principal',
            sales: 'Vendas',
            mainModules: 'MÃ³dulos principais do sistema',
            customerManagement: 'GestÃ£o de relacionamento com clientes',
            salesProposals: 'Propostas, produtos e oportunidades',
            financialControl: 'Controle financeiro e faturamento',
            systemSettings: 'ConfiguraÃ§Ãµes do sistema e integraÃ§Ãµes',
          },
          dashboard: {
            title: 'Dashboard',
            subtitle: 'VisÃ£o geral do seu negÃ³cio',
            newProposal: 'Nova Proposta',
            schedule: 'Agendar',
            themes: 'Temas',
            totalRevenue: 'Faturamento Total',
            averageTicket: 'Ticket MÃ©dio',
            closedSales: 'Vendas Fechadas',
            inNegotiation: 'Em NegociaÃ§Ã£o',
            salesEvolution: 'EvoluÃ§Ã£o de Vendas',
            salesFunnel: 'Funil de Vendas',
            proposalStatus: 'Status das Propostas',
            quickActions: 'AÃ§Ãµes RÃ¡pidas',
            performance: 'Performance',
            recentProposals: 'Propostas Recentes',
            topSellers: 'Top Vendedores',
            leads: 'Leads',
            qualified: 'Qualificados',
            proposals: 'Propostas',
            negotiation: 'NegociaÃ§Ã£o',
            closed: 'Fechados',
            pending: 'Pendentes',
            approved: 'Aprovadas',
            rejected: 'Rejeitadas',
            monthlyGoal: 'Meta Mensal',
            goalAchieved: 'Meta superada! ParabÃ©ns Ã  equipe!',
            vsLastMonth: 'vs mÃªs anterior',
            salesHighlight: 'Vendas em Destaque',
            detailedPerformance: 'Performance detalhada com controles avanÃ§ados',
            currentMonth: 'MÃªs Atual',
            quarter: 'Trimestre',
            semester: 'Semestre',
            fullYear: 'Ano Completo',
            allSellers: 'Todos Vendedores',
            allRegions: 'Todas RegiÃµes',
            northRegion: 'Norte',
            southRegion: 'Sul',
            southeastRegion: 'Sudeste',
            northeastRegion: 'Nordeste',
            centerwestRegion: 'Centro-Oeste',
            lastUpdate: 'Ãšltima atualizaÃ§Ã£o',
            // KPIs
            newClients: 'Novos Clientes MÃªs',
            qualifiedLeads: 'Leads Qualificados',
            sentProposals: 'Propostas Enviadas',
            successRate: 'Taxa Sucesso Geral',
            // SeÃ§Ãµes extras
            alerts: 'Alertas',
            recentActivities: 'Atividades Recentes',
          },
          clients: {
            title: 'Clientes',
            add: 'Adicionar Cliente',
            name: 'Nome',
            email: 'E-mail',
            phone: 'Telefone',
            status: 'Status',
            type: 'Tipo',
            document: 'Documento',
            company: 'Empresa',
            position: 'Cargo',
            source: 'Origem',
            estimatedValue: 'Valor Estimado',
            lastContact: 'Ãšltimo Contato',
            nextContact: 'PrÃ³ximo Contato',
            notes: 'ObservaÃ§Ãµes',
          },
          language: {
            select: 'Selecionar Idioma',
            choose: 'Escolha seu idioma preferido',
            available: 'Idiomas DisponÃ­veis',
            applied: 'As alteraÃ§Ãµes de idioma sÃ£o aplicadas imediatamente',
          },
        },
      },
      'en-US': {
        translation: {
          common: {
            save: 'Save',
            cancel: 'Cancel',
            delete: 'Delete',
            edit: 'Edit',
            add: 'Add',
            search: 'Search',
            loading: 'Loading...',
            error: 'Error',
            success: 'Success',
            actions: 'Actions',
            filters: 'Filters',
            export: 'Export',
            import: 'Import',
            refresh: 'Refresh',
            close: 'Close',
            confirm: 'Confirm',
            all: 'All',
            none: 'None',
            view: 'View',
            viewAll: 'View all',
            preferences: 'Preferences',
            systemLanguage: 'System Language',
            helpSupport: 'Help & Support',
            helpCenter: 'Help Center',
            endSession: 'End Session',
            required: 'required',
            optional: 'optional',
            update: 'Update',
            register: 'Register',
            contact: 'Contact',
            position: 'Position',
            yes: 'Yes',
            no: 'No',
            complement: 'Complement',
            neighborhood: 'Neighborhood',
            subtotal: 'Subtotal',
            discount: 'Discount',
            taxes: 'Taxes',
            cashPayment: 'Cash Payment',
            generateProposal: 'Generate Proposal',
            automaticRenewal: 'Automatic Renewal',
            frequency: 'Frequency',
            saveProduct: 'Save Product',
            contactPerson: 'Contact Person',
            client: 'Client',
          },
          form: {
            requiredFields: 'Required fields marked with *',
            validForm: 'Valid form',
            fieldsWithError: 'field(s) with error',
            fillRequired: 'Fill in all required fields',
            fillAllRequired: 'Fill in all required fields',
            fillAllRequiredFields: 'Fill in all required fields',
          },
          auth: {
            login: 'Sign In',
            logout: 'Sign Out',
            email: 'Email',
            password: 'Password',
            forgotPassword: 'Forgot Password',
            rememberMe: 'Remember Me',
          },
          navigation: {
            dashboard: 'Dashboard',
            clients: 'Clients',
            proposals: 'Proposals',
            products: 'Products',
            contracts: 'Contracts',
            financial: 'Financial',
            settings: 'Settings',
            main: 'Main',
            sales: 'Sales',
            mainModules: 'Main system modules',
            customerManagement: 'Customer relationship management',
            salesProposals: 'Proposals, products and opportunities',
            financialControl: 'Financial control and billing',
            systemSettings: 'System settings and integrations',
          },
          dashboard: {
            title: 'Dashboard',
            subtitle: 'Overview of your business',
            newProposal: 'New Proposal',
            schedule: 'Schedule',
            themes: 'Themes',
            totalRevenue: 'Total Revenue',
            averageTicket: 'Average Ticket',
            closedSales: 'Closed Sales',
            inNegotiation: 'In Negotiation',
            salesEvolution: 'Sales Evolution',
            salesFunnel: 'Sales Funnel',
            proposalStatus: 'Proposal Status',
            quickActions: 'Quick Actions',
            performance: 'Performance',
            recentProposals: 'Recent Proposals',
            topSellers: 'Top Sellers',
            leads: 'Leads',
            qualified: 'Qualified',
            proposals: 'Proposals',
            negotiation: 'Negotiation',
            closed: 'Closed',
            pending: 'Pending',
            approved: 'Approved',
            rejected: 'Rejected',
            monthlyGoal: 'Monthly Goal',
            goalAchieved: 'Goal exceeded! Congratulations to the team!',
            vsLastMonth: 'vs last month',
            salesHighlight: 'Sales Highlight',
            detailedPerformance: 'Detailed performance with advanced controls',
            currentMonth: 'Current Month',
            quarter: 'Quarter',
            semester: 'Semester',
            fullYear: 'Full Year',
            allSellers: 'All Sellers',
            allRegions: 'All Regions',
            northRegion: 'North',
            southRegion: 'South',
            southeastRegion: 'Southeast',
            northeastRegion: 'Northeast',
            centerwestRegion: 'Center-West',
            lastUpdate: 'Last update',
            // KPIs
            newClients: 'New Clients Month',
            qualifiedLeads: 'Qualified Leads',
            sentProposals: 'Sent Proposals',
            successRate: 'Overall Success Rate',
            // SeÃ§Ãµes extras
            alerts: 'Alerts',
            recentActivities: 'Recent Activities',
          },
          clients: {
            title: 'Clients',
            add: 'Add Client',
            name: 'Name',
            email: 'Email',
            phone: 'Phone',
            status: 'Status',
            type: 'Type',
            document: 'Document',
            company: 'Company',
            position: 'Position',
            source: 'Source',
            estimatedValue: 'Estimated Value',
            lastContact: 'Last Contact',
            nextContact: 'Next Contact',
            notes: 'Notes',
          },
          language: {
            select: 'Select Language',
            choose: 'Choose your preferred language',
            available: 'Available Languages',
            applied: 'Language changes are applied immediately',
          },
        },
      },
      'es-ES': {
        translation: {
          common: {
            save: 'Guardar',
            cancel: 'Cancelar',
            delete: 'Eliminar',
            edit: 'Editar',
            add: 'AÃ±adir',
            search: 'Buscar',
            loading: 'Cargando...',
            error: 'Error',
            success: 'Ã‰xito',
            actions: 'Acciones',
            filters: 'Filtros',
            export: 'Exportar',
            import: 'Importar',
            refresh: 'Actualizar',
            close: 'Cerrar',
            confirm: 'Confirmar',
            all: 'Todos',
            none: 'Ninguno',
            view: 'Ver',
            viewAll: 'Ver todos',
            preferences: 'Preferencias',
            systemLanguage: 'Idioma del Sistema',
            helpSupport: 'Ayuda y Soporte',
            helpCenter: 'Centro de Ayuda',
            endSession: 'Cerrar SesiÃ³n',
            required: 'requerido',
            optional: 'opcional',
            update: 'Actualizar',
            register: 'Registrar',
            contact: 'Contacto',
            position: 'PosiciÃ³n',
            yes: 'SÃ­',
            no: 'No',
            complement: 'Complemento',
            neighborhood: 'Barrio',
            subtotal: 'Subtotal',
            discount: 'Descuento',
            taxes: 'Impuestos',
            cashPayment: 'Pago en Efectivo',
            generateProposal: 'Generar Propuesta',
            automaticRenewal: 'RenovaciÃ³n AutomÃ¡tica',
            frequency: 'Frecuencia',
            saveProduct: 'Guardar Producto',
            contactPerson: 'Persona de Contacto',
            client: 'Cliente',
          },
          form: {
            requiredFields: 'Campos obligatorios marcados con *',
            validForm: 'Formulario vÃ¡lido',
            fieldsWithError: 'campo(s) con error',
            fillRequired: 'Complete todos los campos obligatorios',
            fillAllRequired: 'Complete todos los campos obligatorios',
            fillAllRequiredFields: 'Complete todos los campos obligatorios',
          },
          auth: {
            login: 'Iniciar SesiÃ³n',
            logout: 'Cerrar SesiÃ³n',
            email: 'Correo ElectrÃ³nico',
            password: 'ContraseÃ±a',
            forgotPassword: 'OlvidÃ© mi ContraseÃ±a',
            rememberMe: 'Recordarme',
          },
          navigation: {
            dashboard: 'Panel de Control',
            clients: 'Clientes',
            proposals: 'Propuestas',
            products: 'Productos',
            contracts: 'Contratos',
            financial: 'Financiero',
            settings: 'ConfiguraciÃ³n',
            main: 'Principal',
            sales: 'Ventas',
            mainModules: 'MÃ³dulos principales del sistema',
            customerManagement: 'GestiÃ³n de relaciones con clientes',
            salesProposals: 'Propuestas, productos y oportunidades',
            financialControl: 'Control financiero y facturaciÃ³n',
            systemSettings: 'ConfiguraciÃ³n del sistema e integraciones',
          },
          dashboard: {
            title: 'Panel de Control',
            subtitle: 'VisiÃ³n general de su negocio',
            newProposal: 'Nueva Propuesta',
            schedule: 'Programar',
            themes: 'Temas',
            totalRevenue: 'Ingresos Totales',
            averageTicket: 'Ticket Promedio',
            closedSales: 'Ventas Cerradas',
            inNegotiation: 'En NegociaciÃ³n',
            salesEvolution: 'EvoluciÃ³n de Ventas',
            salesFunnel: 'Embudo de Ventas',
            proposalStatus: 'Estado de Propuestas',
            quickActions: 'Acciones RÃ¡pidas',
            performance: 'Rendimiento',
            recentProposals: 'Propuestas Recientes',
            topSellers: 'Mejores Vendedores',
            leads: 'Leads',
            qualified: 'Calificados',
            proposals: 'Propuestas',
            negotiation: 'NegociaciÃ³n',
            closed: 'Cerrados',
            pending: 'Pendientes',
            approved: 'Aprobadas',
            rejected: 'Rechazadas',
            monthlyGoal: 'Meta Mensual',
            goalAchieved: 'Â¡Meta superada! Â¡Felicidades al equipo!',
            vsLastMonth: 'vs mes anterior',
            salesHighlight: 'Destacado de Ventas',
            detailedPerformance: 'Rendimiento detallado con controles avanzados',
            currentMonth: 'Mes Actual',
            quarter: 'Trimestre',
            semester: 'Semestre',
            fullYear: 'AÃ±o Completo',
            allSellers: 'Todos los Vendedores',
            allRegions: 'Todas las Regiones',
            northRegion: 'Norte',
            southRegion: 'Sur',
            southeastRegion: 'Sureste',
            northeastRegion: 'Noreste',
            centerwestRegion: 'Centro-Oeste',
            lastUpdate: 'Ãšltima actualizaciÃ³n',
            // KPIs
            newClients: 'Nuevos Clientes Mes',
            qualifiedLeads: 'Leads Calificados',
            sentProposals: 'Propuestas Enviadas',
            successRate: 'Tasa Ã‰xito General',
            // SeÃ§Ãµes extras
            alerts: 'Alertas',
            recentActivities: 'Actividades Recientes',
          },
          clients: {
            title: 'Clientes',
            add: 'AÃ±adir Cliente',
            name: 'Nombre',
            email: 'Correo ElectrÃ³nico',
            phone: 'TelÃ©fono',
            status: 'Estado',
            type: 'Tipo',
            document: 'Documento',
            company: 'Empresa',
            position: 'Cargo',
            source: 'Origen',
            estimatedValue: 'Valor Estimado',
            lastContact: 'Ãšltimo Contacto',
            nextContact: 'PrÃ³ximo Contacto',
            notes: 'Observaciones',
          },
          language: {
            select: 'Seleccionar Idioma',
            choose: 'Elija su idioma preferido',
            available: 'Idiomas Disponibles',
            applied: 'Los cambios de idioma se aplican inmediatamente',
          },
        },
      },
      'fr-FR': {
        translation: {
          common: {
            save: 'Enregistrer',
            cancel: 'Annuler',
            delete: 'Supprimer',
            edit: 'Modifier',
            add: 'Ajouter',
            search: 'Rechercher',
            loading: 'Chargement...',
            error: 'Erreur',
            success: 'SuccÃ¨s',
            actions: 'Actions',
            filters: 'Filtres',
            export: 'Exporter',
            import: 'Importer',
            refresh: 'Actualiser',
            close: 'Fermer',
            confirm: 'Confirmer',
            all: 'Tous',
            none: 'Aucun',
            view: 'Voir',
            viewAll: 'Voir tout',
            preferences: 'PrÃ©fÃ©rences',
            systemLanguage: 'Langue du SystÃ¨me',
            helpSupport: 'Aide et Support',
            helpCenter: 'Centre d\'Aide',
            endSession: 'Fermer la Session',
            required: 'requis',
            optional: 'optionnel',
            update: 'Mettre Ã  jour',
            register: 'Enregistrer',
            contact: 'Contact',
            position: 'Position',
            yes: 'Oui',
            no: 'Non',
            complement: 'ComplÃ©ment',
            neighborhood: 'Quartier',
            subtotal: 'Sous-total',
            discount: 'Remise',
            taxes: 'Taxes',
            cashPayment: 'Paiement Comptant',
            generateProposal: 'GÃ©nÃ©rer une Proposition',
            automaticRenewal: 'Renouvellement Automatique',
            frequency: 'FrÃ©quence',
            saveProduct: 'Enregistrer le Produit',
            contactPerson: 'Personne de Contact',
            client: 'Client',
          },
          form: {
            requiredFields: 'Champs obligatoires marquÃ©s avec *',
            validForm: 'Formulaire valide',
            fieldsWithError: 'champ(s) avec erreur',
            fillRequired: 'Remplir tous les champs obligatoires',
            fillAllRequired: 'Remplir tous les champs obligatoires',
            fillAllRequiredFields: 'Remplir tous les champs obligatoires',
          },
          auth: {
            login: 'Se Connecter',
            logout: 'Se DÃ©connecter',
            email: 'E-mail',
            password: 'Mot de Passe',
            forgotPassword: 'Mot de Passe OubliÃ©',
            rememberMe: 'Se Souvenir de Moi',
          },
          navigation: {
            dashboard: 'Tableau de Bord',
            clients: 'Clients',
            proposals: 'Propositions',
            products: 'Produits',
            contracts: 'Contrats',
            financial: 'Financier',
            settings: 'ParamÃ¨tres',
            main: 'Principal',
            sales: 'Ventes',
            mainModules: 'Modules principaux du systÃ¨me',
            customerManagement: 'Gestion de la relation client',
            salesProposals: 'Propositions, produits et opportunitÃ©s',
            financialControl: 'ContrÃ´le financier et facturation',
            systemSettings: 'ParamÃ¨tres systÃ¨me et intÃ©grations',
          },
          dashboard: {
            title: 'Tableau de Bord',
            subtitle: 'AperÃ§u de votre entreprise',
            newProposal: 'Nouvelle Proposition',
            schedule: 'Planifier',
            themes: 'ThÃ¨mes',
            totalRevenue: 'Chiffre d\'Affaires Total',
            averageTicket: 'Ticket Moyen',
            closedSales: 'Ventes FermÃ©es',
            inNegotiation: 'En NÃ©gociation',
            salesEvolution: 'Ã‰volution des Ventes',
            salesFunnel: 'Entonnoir de Ventes',
            proposalStatus: 'Statut des Propositions',
            quickActions: 'Actions Rapides',
            performance: 'Performance',
            recentProposals: 'Propositions RÃ©centes',
            topSellers: 'Meilleurs Vendeurs',
            leads: 'Prospects',
            qualified: 'QualifiÃ©s',
            proposals: 'Propositions',
            negotiation: 'NÃ©gociation',
            closed: 'FermÃ©s',
            pending: 'En Attente',
            approved: 'ApprouvÃ©es',
            rejected: 'RejetÃ©es',
            monthlyGoal: 'Objectif Mensuel',
            goalAchieved: 'Objectif dÃ©passÃ© ! FÃ©licitations Ã  l\'Ã©quipe !',
            vsLastMonth: 'vs mois dernier',
            salesHighlight: 'Point Fort des Ventes',
            detailedPerformance: 'Performance dÃ©taillÃ©e avec contrÃ´les avancÃ©s',
            currentMonth: 'Mois Actuel',
            quarter: 'Trimestre',
            semester: 'Semestre',
            fullYear: 'AnnÃ©e ComplÃ¨te',
            allSellers: 'Tous les Vendeurs',
            allRegions: 'Toutes les RÃ©gions',
            northRegion: 'Nord',
            southRegion: 'Sud',
            southeastRegion: 'Sud-Est',
            northeastRegion: 'Nord-Est',
            centerwestRegion: 'Centre-Ouest',
            lastUpdate: 'DerniÃ¨re mise Ã  jour',
            // KPIs
            newClients: 'Nouveaux Clients Mois',
            qualifiedLeads: 'Prospects QualifiÃ©s',
            sentProposals: 'Propositions EnvoyÃ©es',
            successRate: 'Taux SuccÃ¨s GÃ©nÃ©ral',
            // SeÃ§Ãµes extras
            alerts: 'Alertes',
            recentActivities: 'ActivitÃ©s RÃ©centes',
          },
          clients: {
            title: 'Clients',
            add: 'Ajouter Client',
            name: 'Nom',
            email: 'E-mail',
            phone: 'TÃ©lÃ©phone',
            status: 'Statut',
            type: 'Type',
            document: 'Document',
            company: 'Entreprise',
            position: 'Poste',
            source: 'Source',
            estimatedValue: 'Valeur EstimÃ©e',
            lastContact: 'Dernier Contact',
            nextContact: 'Prochain Contact',
            notes: 'Notes',
          },
          language: {
            select: 'SÃ©lectionner la Langue',
            choose: 'Choisissez votre langue prÃ©fÃ©rÃ©e',
            available: 'Langues Disponibles',
            applied: 'Les changements de langue sont appliquÃ©s immÃ©diatement',
          },
        },
      },
    },
  });

interface I18nContextData {
  language: string;
  changeLanguage: (lng: string) => Promise<void>;
  t: (key: string) => string;
  availableLanguages: Array<{
    code: string;
    name: string;
    nativeName: string;
    flag: string;
  }>;
}

const I18nContext = createContext<I18nContextData>({} as I18nContextData);

interface I18nProviderProps {
  children: ReactNode;
}

export const I18nProvider: React.FC<I18nProviderProps> = ({ children }) => {
  const [currentLanguage, setCurrentLanguage] = useState(i18n.language);
  const [forceUpdate, setForceUpdate] = useState(0); // Para forÃ§ar re-renderizaÃ§Ã£o

  const availableLanguages = [
    {
      code: 'pt-BR',
      name: 'PortuguÃªs (Brasil)',
      nativeName: 'PortuguÃªs',
      flag: 'ðŸ‡§ðŸ‡·'
    },
    {
      code: 'en-US',
      name: 'English (United States)',
      nativeName: 'English',
      flag: 'ðŸ‡ºðŸ‡¸'
    },
    {
      code: 'es-ES',
      name: 'EspaÃ±ol (EspaÃ±a)',
      nativeName: 'EspaÃ±ol',
      flag: 'ðŸ‡ªðŸ‡¸'
    },
    {
      code: 'fr-FR',
      name: 'FranÃ§ais (France)',
      nativeName: 'FranÃ§ais',
      flag: 'ðŸ‡«ðŸ‡·'
    }
  ];

  useEffect(() => {
    const handleLanguageChange = (lng: string) => {
      setCurrentLanguage(lng);
      setForceUpdate(prev => prev + 1); // ForÃ§a re-renderizaÃ§Ã£o
    };

    // Definir idioma inicial baseado na detecÃ§Ã£o
    setCurrentLanguage(i18n.language);

    i18n.on('languageChanged', handleLanguageChange);

    return () => {
      i18n.off('languageChanged', handleLanguageChange);
    };
  }, []);

  const changeLanguage = async (lng: string) => {
    try {
      await i18n.changeLanguage(lng);

      // Salvar preferÃªncia no localStorage
      localStorage.setItem('preferred-language', lng);

      // ForÃ§ar atualizaÃ§Ã£o imediata
      setCurrentLanguage(lng);
      setForceUpdate(prev => prev + 1);
    } catch (error) {
      console.error('âŒ Erro ao alterar idioma:', error);
    }
  };

  const t = useCallback((key: string) => {
    return i18n.t(key);
  }, [currentLanguage, forceUpdate]); // Re-create the function when language changes

  const value: I18nContextData = {
    language: currentLanguage,
    changeLanguage,
    t,
    availableLanguages,
  };

  return <I18nContext.Provider value={value}>{children}</I18nContext.Provider>;
};

export const useI18n = () => {
  const context = useContext(I18nContext);
  if (!context) {
    throw new Error('useI18n deve ser usado dentro de um I18nProvider');
  }
  return context;
};
